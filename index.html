<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Quadtych mobile-first</title>

  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.4/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.12.2/dist/ml5.min.js"></script>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; padding:0; background:#0b0b0b; color:#ddd; font-family: system-ui, -apple-system, Segoe UI, Roboto; }
    #topbar{
      position: sticky; top: 0; z-index: 10;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(8px);
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    #buttons button{
      margin-right:8px; margin-bottom:8px;
      padding:10px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff; font-size:14px;
    }
    #wrap{ max-width: 1100px; margin: 0 auto; padding: 10px 12px 24px; }
    canvas{ width:100% !important; height:auto !important; display:block; border-radius:14px; }
    #log{
      width:100%; min-height: 240px; height: 32vh;
      margin-top: 12px;
      padding: 12px 12px;
      box-sizing: border-box;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: #070707; color: #d8d8d8;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px; line-height: 1.35;
      white-space: pre; overflow:auto;
    }
    .hint { opacity:0.9; font-size: 13px; line-height:1.35; margin-top:6px; }
  </style>
</head>

<body>
  <div id="topbar">
    <div id="buttons"></div>
    <div class="hint" id="status">Tap to enable camera (iPhone: Safari-ban)</div>
  </div>

  <div id="wrap">
    <!-- p5 canvas ide kerül -->
    <textarea id="log" spellcheck="false">MACHINE STREAM (copyable)
---------------------------------------------------------------</textarea>
  </div>

<script>
/* ================== Mobil-first layout ================== */
let P = 520;                 // dinamikus lesz
let CANVAS_W = 520;
let CANVAS_H = 520;

let isMobileLayout = true;   // dinamikus
function computeLayout() {
  const vw = Math.min(window.innerWidth, 1100);
  const vh = window.innerHeight;

  // panel méret: kijelző szélességhez igazítva
  P = Math.floor(Math.min(vw - 24, 720));
  P = Math.max(320, P);

  // mobil: 1 oszlop, 4 sor (görgethető)
  isMobileLayout = (window.innerWidth < 900);

  if (isMobileLayout) {
    CANVAS_W = P;
    CANVAS_H = P * 4;
  } else {
    CANVAS_W = P * 2;
    CANVAS_H = P * 2;
  }
}

/* ================== Kamera (iOS tap-to-start) ================== */
const camW = 640, camH = 480;
let cam = null, offG = null;
let camInit = null;

async function startIPhoneCamera({ useBackCamera = true } = {}) {
  if (!navigator.mediaDevices?.getUserMedia) {
    alert("Nincs getUserMedia támogatás ebben a böngészőben.");
    return null;
  }

  const constraints = {
    audio: false,
    video: {
      width: { ideal: camW },
      height: { ideal: camH },
      facingMode: useBackCamera ? { ideal: "environment" } : "user"
    }
  };

  const stream = await navigator.mediaDevices.getUserMedia(constraints);

  // p5 videó elem (stabilabb így)
  const v = createVideo([]);
  v.elt.srcObject = stream;
  v.elt.setAttribute("playsinline", "");
  v.elt.setAttribute("webkit-playsinline", "");
  v.elt.muted = true;
  v.elt.autoplay = true;

  v.size(camW, camH);
  v.hide();

  return { p5video: v, stream };
}

async function ensureCameraStarted() {
  if (camInit) return camInit;
  camInit = startIPhoneCamera({ useBackCamera: true })
    .then(res => {
      if (!res) return null;
      cam = res.p5video;
      // user gesture után próbáljuk a play-t
      return cam.elt.play().catch(() => {});
    })
    .catch(err => {
      console.error(err);
      alert("Kamera hiba / engedély megtagadva. iPhone: Safari + kamera engedély + HTTPS.");
      camInit = null;
      return null;
    });
  return camInit;
}

function touchStarted() { ensureCameraStarted(); return false; }
function mousePressed() { ensureCameraStarted(); }

/* ================== UI: log + mentés ================== */
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');

function saveImageIOS(getImgFn) {
  const img = getImgFn();
  const dataUrl = img.canvas.toDataURL('image/png');
  const w = window.open('', '_blank');
  if (!w) { alert("Popup blokkolva. Safari: engedélyezd a pop-upot."); return; }
  w.document.write(`
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Save image</title>
    <style>body{margin:0;background:#000;display:flex;align-items:center;justify-content:center}</style>
    <img src="${dataUrl}" style="max-width:100%;height:auto" />
    <p style="position:fixed;bottom:10px;left:10px;color:#fff;font-family:system-ui">
      iPhone: hosszan nyomd a képet → “Save to Photos”
    </p>
  `);
  w.document.close();
}

function addButtons() {
  const box = document.getElementById('buttons');
  box.innerHTML = '';

  const mk = (label, fn) => {
    const b = document.createElement('button');
    b.textContent = label;
    b.onclick = fn;
    box.appendChild(b);
  };

  mk('SAVE FULL', () => saveImageIOS(() => get(0, 0, CANVAS_W, CANVAS_H)));
  mk('SAVE P1',   () => saveImageIOS(() => get(panelRect(1).x, panelRect(1).y, P, P)));
  mk('SAVE P2',   () => saveImageIOS(() => get(panelRect(2).x, panelRect(2).y, P, P)));
  mk('SAVE P3',   () => saveImageIOS(() => get(panelRect(3).x, panelRect(3).y, P, P)));
  mk('SAVE P4',   () => saveImageIOS(() => get(panelRect(4).x, panelRect(4).y, P, P)));
}

/* ================== Panel koordináták ================== */
function panelRect(n) {
  if (isMobileLayout) {
    // 1 oszlop, 4 sor
    return { x: 0, y: (n-1)*P, w: P, h: P };
  }
  // desktop 2×2
  if (n === 1) return { x: 0,   y: 0,   w: P, h: P };
  if (n === 2) return { x: P,   y: 0,   w: P, h: P };
  if (n === 3) return { x: 0,   y: P,   w: P, h: P };
  return           { x: P,   y: P,   w: P, h: P };
}

/* ================== A TE RÉGI ÁLLAPOTAID ide jönnek ================== */
/* Itt hagyd meg a saját AI/CV/lum/particles változóidat,
   csak a fix 1920-as konstansokat NE használd többé. */

const gridCols = 72, gridRows = 54;
let lumField = [], lumFieldSm = [], avgBrightness = 0;

// --- stb... ide jön a detector/cv/particles/lineMemG stb. a régi kódból ---

/* ================== setup/draw ================== */
function setup() {
  computeLayout();
  const c = createCanvas(CANVAS_W, CANVAS_H);
  c.parent('wrap');
  pixelDensity(1);

  offG = createGraphics(camW, camH);
  offG.pixelDensity(1);

  addButtons();

  // init lum mezők (példa)
  for (let r = 0; r < gridRows; r++) {
    lumField[r] = new Array(gridCols).fill(0);
    lumFieldSm[r] = new Array(gridCols).fill(0);
  }

  // >>> IDE: a régi setupod többi része (COCO init, OpenCV init, lineMemG init, stb.)
}

function windowResized() {
  computeLayout();
  resizeCanvas(CANVAS_W, CANVAS_H);
  addButtons();
}

function draw() {
  if (!cam || !cam.elt || cam.elt.readyState < 2) {
    background(10);
    fill(255);
    textSize(16);
    text("Tap to enable camera", 14, 34);
    textSize(12);
    text("iPhone: Safari-ban nyisd meg + engedélyezd a kamerát.", 14, 54);
    statusEl.textContent = "Kamera: WAIT (tap)";
    return;
  }

  statusEl.textContent = "Kamera: OK";

  // camera -> offscreen + flip
  offG.push();
  offG.translate(camW, 0);
  offG.scale(-1, 1);
  offG.image(cam, 0, 0, camW, camH);
  offG.pop();

  // >>> IDE: a régi computeBrightnessAndField(offG), computeOptimal..., runOpenCV, detect, log, stb.

  // Render panelek:
  const r1 = panelRect(1);
  const r2 = panelRect(2);
  const r3 = panelRect(3);
  const r4 = panelRect(4);

  // >>> IDE: a régi drawPanel1/2/3/4 meghívásaid, csak a koordinátákat a rectekből add:
  // drawPanel1(r1.x, r1.y, r1.w, r1.h);
  // drawPanel2(r2.x, r2.y, r2.w, r2.h);
  // drawPanel3(r3.x, r3.y, r3.w, r3.h);
  // drawPanel4BG(r4.x, r4.y, r4.w, r4.h);
  // drawPanel4TextToCanvas(r4.x, r4.y, r4.w, r4.h);

  // Ha még nincs átmásolva, addig csak preview:
  noStroke(); fill(20);
  rect(r1.x, r1.y, r1.w, r1.h); fill(255); text("P1", r1.x+12, r1.y+20);
  fill(20); rect(r2.x, r2.y, r2.w, r2.h); fill(255); text("P2", r2.x+12, r2.y+20);
  fill(20); rect(r3.x, r3.y, r3.w, r3.h); fill(255); text("P3", r3.x+12, r3.y+20);
  fill(20); rect(r4.x, r4.y, r4.w, r4.h); fill(255); text("P4 (log)", r4.x+12, r4.y+20);
}
</script>
</body>
</html>
